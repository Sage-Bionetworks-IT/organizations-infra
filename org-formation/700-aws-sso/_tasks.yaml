Parameters:
  <<: !Include '../_parameters.yaml'

  appName:
    Type: String
    Default: 'sso'

  # AWS SSO instance ARN
  instanceArn:
    Type: String
    Default: 'arn:aws:sso:::instance/ssoins-7223f51628aaa549'

#----------------------------------------------------------------------------------------------
# Mapping Jumpcloud groups to AWS SSO groups which are automatically synced to JC groups.

  adminGroup:           #JC aws-admins
    Type: String
    Default: '906769aa66-4b16d4b3-7c9c-44b7-85e0-adbf41dbf49d'

  developerGroup:     #JC aws-develoers
    Type: String
    Default: '906769aa66-49d7689b-ae36-472b-bc3d-893753529227'

  scienceSupporterGroup:      #JC aws-science-supporters
    Type: String
    Default: '906769aa66-5d23a723-54f3-4c08-a67b-311e555f4e85'

  scicompViewerGroup:      #JC aws-scicomp-viewers
    Type: String
    Default: '906769aa66-4796775f-cf5f-41c2-bfed-40b1d2658a3f'

  scicompDeveloperGroup:   #JC aws-scicomp-developers
    Type: String
    Default: '906769aa66-8c4034aa-9441-47b2-8770-34422ea4affa'

  mobileHealthDataEngineeringDevAdminGroup:     #JC aws-mobilehealth-dataengineering-dev-admins
    Type: String
    Default: '906769aa66-e218c196-4107-417d-8b75-c2e81a4aa290'

  mobileHealthDataEngineeringDevViewerGroup:     #JC aws-mobilehealth-dataengineering-dev-viewers
    Type: String
    Default: '906769aa66-72c01182-929a-4014-a2df-d864148a3085'

  mobileHealthDataEngineeringProdAdminGroup:   #JC aws-mobilehealth-dataengineering-prod-admins
    Type: String
    Default: '906769aa66-d82d80f8-3c90-4faf-be30-437e9e60e31f'

  mobileHealthDataEngineeringProdViewerGroup:   #JC aws-mobilehealth-dataengineering-prod-viewers
    Type: String
    Default: '906769aa66-89cf459f-e670-49c1-9771-f71f5fa1f9b0'

  workflowNextflowDevAdminGroup:     #JC aws-workflow-nextflow-dev-admin
    Type: String
    Default: '906769aa66-023cdfaa-15f0-43d9-b823-b74358ceffd7'

  workflowNextflowDevDeveloperGroup:    #JC aws-workflows-nextflow-dev-developers
    Type: String
    Default: '906769aa66-4c409d3e-e03d-4f46-aa24-840c977ef9d4'

  workflowNextflowProdAdminGroup:   #JC aws-workflow-nextflow-prod-admin
    Type: String
    Default: '906769aa66-5c67ab0f-1091-48f9-b5b9-37d8b99a446a'

  workflowNextflowTowerViewerGroup:   #JC aws-workflow-nextflow-tower-viewer
    Type: String
    Default: '906769aa66-6cdd2cc1-6d3d-49d8-b105-37c22bb3d402'

  synapseDevAdminGroup:   #JC aws-synapsedev-admins
    Type: String
    Default: '44d844b8-60a1-70e5-cb5a-50137c984398'

  synapseProdAdminGroup:  #JC aws-synapseprod-admins
    Type: String
    Default: '34783488-c0c1-701b-d093-6f4f8edcf2d7'

  synapseDevDeveloperGroup:     #JC aws-synapsedev-developers
    Type: String
    Default: '906769aa66-74e6487e-6e4e-4734-ba40-0de48cd03511'

  synapseProdDeveloperGroup:   #JC aws-synapseprod-developers
    Type: String
    Default: '906769aa66-45b9f3f5-95bf-4832-9fa2-a6541eafe623'

  synapseProdViewerGroup:     #JC aws-synapseprod-viewers
    Type: String
    Default: '906769aa66-f671b9c2-3131-4051-b712-4668914bbfe0'

  synapseDevAthenaGroup:     #JC aws-synapsedev-athena-users
    Type: String
    Default: 'e408d4d8-90e1-70a0-b1ab-d8edded2d3b0'

  synapseProdAthenaGroup:     #JC aws-synapseprod-athena-users
    Type: String
    Default: '74c8e468-b0d1-702d-5d09-f2193ebf20c3'

  imageCentralAmiLibrarianGroup:   #JC aws-imagecentral-ami-librarians
    Type: String
    Default: '906769aa66-8bfbe918-2d30-467e-9e98-92232e9f8410'

  bridgeDevAdminGroup:      #JC aws-bridgedev-admins
    Type: String
    Default: '906769aa66-9cc57bee-09aa-44f6-83a2-13a6c5a1f9ea'

  bridgeProdAdminGroup:     #JC aws-bridgeprod-admins
    Type: String
    Default: '906769aa66-a07374c5-95e8-4575-ac6d-735ab2381671'

  bridgeDevDeveloperGroup:   #JC aws-bridgedev-developers
    Type: String
    Default: '906769aa66-e3bd9dc2-140a-49b9-96b7-2b7c96690109'

  bridgeProdDeveloperGroup:   #JC aws-bridgeprod-developers
    Type: String
    Default: '906769aa66-69906933-ccee-48dd-bbb6-a692eec3db9d'

  bridgeProdIosDeveloperGroup:  #JC aws-bridgeprod-ios-developers
    Type: String
    Default: '906769aa66-e7083100-27d4-49bd-8ed2-c588371a1f91'

  bridgeParticipantManagerGroup:  #JC aws-bridge-participant-managers
    Type: String
    Default: '44085488-70f1-704b-c058-b6dde3aba1ef'

  scipoolDevAdminGroup:       #JC aws-scipooldev-admins
    Type: String
    Default: '906769aa66-5215fbe3-2331-4ea6-9cb3-ee25cdad4cc8'

  scipoolProdAdminGroup:      #JC aws-scipoolprod-admins
    Type: String
    Default: '906769aa66-b4f7fcde-028e-4c66-b25d-e9cfaf51c30f'

  scipoolDevCommunityManagerGroup:   #JC aws-scipooldev-community-managers
    Type: String
    Default: '906769aa66-e25208e2-9a4a-420b-ab2a-8b880b39dbc3'

  scipoolProdCommunityManagerGroup:  #JC aws-scipoolprod-community-managers
    Type: String
    Default: '906769aa66-01abc2a0-764f-447e-b6e7-649dc83bdcda'

  adminCentralCfnDeployerGroup:   #JC aws-admincentral-cfn-deployers
    Type: String
    Default: '906769aa66-f7cda126-3384-4fc0-bf6d-c01a00172e6d'

  htanDevAdminGroup:        #JC aws-htan-dev-admins
    Type: String
    Default: '906769aa66-8f870ac5-9280-4c19-b477-461592fe92a6'

  bmgfkiAdminGroup:      #JC aws-bmgfki-admins
    Type: String
    Default: '906769aa66-dfc5248b-3d5d-44ce-81ae-6759ee284e59'

  bmgfkiCommunityManagerGroup:  #JC aws-bmgfki-community-managers
    Type: String
    Default: '906769aa66-0a6a0177-d4cf-47e4-a5bc-4ba5297995ff'

  cnbAdminGroup:      #JC aws-cnb-admins
    Type: String
    Default: '906769aa66-911ad81b-8331-4670-a8eb-d53c63d6a0e1'

  scicompIncludeDccCollabGroup:      #JC aws-scicomp-include-dcc-collabs
    Type: String
    Default: '906769aa66-b713e6a6-fe9b-4737-919e-c1d4bc4a8447'

  agoraProdAdminGroup:     #JC aws-agoraprod-admins
    Type: String
    Default: '906769aa66-af067ea3-406a-4a69-ab39-251fed985d86'

  agoraProdDeveloperGroup:   #JC aws-agoraprod-developers
    Type: String
    Default: '906769aa66-45d850f1-c67b-40fd-a3ce-d9b670712543'

  agoraDevAdminGroup:     #JC aws-agoradev-admins
    Type: String
    Default: '906769aa66-3fd73ca7-ea84-44ad-812a-2555aa3da618'

  agoraDevDeveloperGroup:   #JC aws-agoradev-developers
    Type: String
    Default: '906769aa66-97799c36-3766-4b50-9a0a-62b22d9a5c60'

  includeChopProdAdminGroup:     #JC aws-includechopprod-admins
    Type: String
    Default: '906769aa66-a5b83d7c-4846-4f46-b134-608d66060765'

  includeChopProdDeveloperGroup:   #JC aws-includechopprod-developers
    Type: String
    Default: '906769aa66-24060cf5-7100-4c45-a9be-27c3ff5aba69'

  dnTDevAdminGroup:     #JC aws-dntdev-admins
    Type: String
    Default: '906769aa66-c017dd5e-4872-4bd1-8b5c-c0cc92088dfc'

  dnTDevDeveloperGroup:   #JC aws-dntdev-developers
    Type: String
    Default: '906769aa66-e78063c9-9fc6-4654-a089-ebb26854f202'

  dntDevViewerGroup:      #JC aws-dntdev-viewers
    Type: String
    Default: '906769aa66-1d010ba3-e9cd-451b-98fd-f60bb7e3965d'

  dntDevApplicationManagerGroup:      #JC aws-dntdev-application-managers
    Type: String
    Default: 'd4f8f4d8-f051-7008-e356-7622368ce737'

  identityCentralS3ExternalCollabGroup:      #JC aws-identitycentral-s3-external-collab
    Type: String
    Default: 'e4880448-e061-70b3-2487-e2c54abce711'

  recoverDevAdminGroup:      #JC aws-recover-dev-admins
    Type: String
    Default: '94a8e488-00d1-70a4-1c05-d864077490d6'

  recoverDevDeveloperGroup:      #JC aws-recover-dev-developers
    Type: String
    Default: '54e8e448-1051-70e2-2607-b109750355bd'

  recoverDevViewerGroup:      #JC aws-recover-dev-viewers
    Type: String
    Default: 'a46824e8-e0d1-709b-457d-90d57d6a71be'

  recoverProdAdminGroup:      #JC aws-recover-prod-admins
    Type: String
    Default: '54d83448-10a1-7000-7e72-cae28f0caacf'

  recoverProdDeveloperGroup:      #JC aws-recover-prod-developers
    Type: String
    Default: 'a468b478-f021-7010-535b-4ad779417559'

  recoverProdViewerGroup:      #JC aws-recover-prod-viewers
    Type: String
    Default: 'b4e86468-f091-70e2-0ea9-64cf3addcdf1'

  recoverDigitalHealthAnalyticsGroup:   #JC aws-recover-digital-health-analytics
    Type: String
    Default: 'c45834f8-1021-70e2-66a2-15edb4d44c30'

  dcaProdViewersGroup:      #JC aws-dca-prod-viewers
    Type: String
    Default: '14187418-6081-7044-6e34-07f86b336cdd'

  dcaProdViewersPlusGroup:      #JC aws-dca-prod-viewers-plus
    Type: String
    Default: 'c448e498-60d1-7084-5cf5-14d77b82a42b'

  dcaProdApplicationManagerGroup:      # JC aws-dca-prod-application-managers
    Type: String
    Default: '540864c8-1021-7048-7142-4563c3f12645'

  genieProdViewerGroup:      #JC aws-genie-prod-viewers
    Type: String
    Default: '9478a4f8-3001-707d-dadb-0c9fffb968be'

  genieProdViewerPlusGroup:      #JC aws-genie-prod-viewers-plus
    Type: String
    Default: '4428e4d8-d0e1-7042-59a1-85b676374bb9'

  genieProdApplicationManagerGroup:      # JC aws-genie-prod-application-managers
    Type: String
    Default: '14e83438-3051-7019-77d3-5d1cb3ec7d42'

  dpeProdAdminGroup:      #JC aws-dpe-prod-admins
    Type: String
    Default: 'c408c488-e0c1-70cb-91fa-fe5b3e113bb0'

  dpeProdDeveloperGroup:      #JC aws-dpe-prod-developers
    Type: String
    Default: '34b8b4a8-90e1-70c0-9223-4a663d28e2ff'

  dpeProdViewerGroup:      #JC aws-dpe-prod-viewers
    Type: String
    Default: '64284488-1061-70c9-eacb-f465d1988789'

  ipamViewerPlusGroup:      #JC aws-ipam-viewers-plus
    Type: String
    Default: '0498c498-5041-704e-c4bb-c3eb14f2fdbb'

  monitorCentralViewerPlusGroup:      #JC aws-monitorcentral-viewers-plus
    Type: String
    Default: 'a4887438-9071-7060-e244-6cfcc242d43b'

  scceDevAdminGroup:      #JC aws-sccedev-admins
    Type: String
    Default: 'b47864c8-1001-7096-1bce-5f09fbeb1b65'

  scceDevDeveloperGroup:      #JC aws-sccedev-developers
    Type: String
    Default: '54a83488-c0e1-7021-5286-175d851517c8'

  scceDevViewerGroup:      #JC aws-sccedev-viewers
    Type: String
    Default: '84684498-7091-7091-4439-6c14af98c06e'

  scceDevViewerPlusGroup:      #JC aws-sccedev-viewers-plus
    Type: String
    Default: '84d8d478-6081-7091-b9e9-b44d97a6bcb3'

  cnbDevAdminGroup:      #JC aws-cnb-dev-admins
    Type: String
    Default: 'b43864e8-a0b1-7008-924f-54a58df1ae28'

  cnbDevDeveloperGroup:      #JC aws-cnb-dev-developers
    Type: String
    Default: '04a83488-1041-70d0-e200-31472f87c82a'

  itsandboxDeveloperGroup:      #JC aws-itsandbox-developers
    Type: String
    Default: 'c4e88408-70b1-70ce-83be-76f4f694b6a6'

  financeAuditorGroup:  # JC aws-finance-auditors
    Type: String
    Default: 'd438e4d8-90e1-7030-6998-cad12c0d3296'

  securityAuditorGroup:     # JC aws-security-auditors
    Type: String
    Default: '2448e4e8-50b1-70e5-def0-07e0f4fcd60e'

  #------------- personal AWS accounts ------------------
  BuA2aDwAdminGroup:             #JC aws-BuA2aDw-admins
    Type: String
    Default: '14b8f4c8-60e1-70ef-e296-06e88f14d720'

  BWmErzkAdminGroup:             #JC aws-BWmErzk-admins
    Type: String
    Default: '143894c8-1031-70c4-b98a-9d2a9aec59bd'

#----------------------------------------------------------------------------------------------

SsoAdministrator:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-admin'
  StackDescription: 'Full permission role used by Admin group within whole organization'
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: '*'
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref adminGroup
    permissionSetName: 'Administrator'
    managedPolicies:
      - 'arn:aws:iam::aws:policy/AdministratorAccess'
      - 'arn:aws:iam::aws:policy/AWSKeyManagementServicePowerUser'
    sessionDuration: 'PT8H'
    masterAccountId: !Ref MasterAccount

SsoAdministratorSupporter:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-admin-supporter'
  StackDescription: 'Full permission role used by Supporter group within Production organizational units'
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      OrganizationalUnit:
        - !Ref ScienceDevOU
        - !Ref ScienceProdOU
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scienceSupporterGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoDeveloper:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.5.1/templates/SSO/aws-sso.njk
  TemplatingContext:
    customerManagedPolicies:
      - Name: !Ref CostExplorerPolicyName
  StackName: !Sub '${resourcePrefix}-${appName}-developer'
  StackDescription: 'Read and Write role used by Developer group within SDLC organizational units'
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      OrganizationalUnit:
        - !Ref ScienceDevOU
        - !Ref ScienceProdOU
      Account: '*'
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref developerGroup
    permissionSetName: 'Developer'
    managedPolicies:
      - 'arn:aws:iam::aws:policy/PowerUserAccess'
      - 'arn:aws:iam::aws:policy/AdministratorAccess-AWSElasticBeanstalk'
      - 'arn:aws:iam::aws:policy/AWSBillingReadOnlyAccess'
      - 'arn:aws:iam::aws:policy/AmazonBedrockFullAccess'
    sessionDuration: 'PT12H'
    inlinePolicy: >-
      {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Effect": "Deny",
                  "Action": "sts:AssumeRole",
                  "Resource": "*"
              }
          ]
      }

SsoFinanceAuditor:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.7.7/templates/SSO/aws-sso.njk
  TemplatingContext:
    customerManagedPolicies:
      - Name: !Ref CostExplorerPolicyName
  StackName: !Sub '${resourcePrefix}-${appName}-finance-auditor'
  StackDescription: 'Role used by Finance Auditor group within whole organization'
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: '*'
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref financeAuditorGroup
    permissionSetName: 'FinanceAuditor'
    managedPolicies:
      - 'arn:aws:iam::aws:policy/job-function/SupportUser'
      - 'arn:aws:iam::aws:policy/AWSBillingReadOnlyAccess'
    sessionDuration: 'PT8H'
    masterAccountId: !Ref MasterAccount

SsoSecurityAuditor:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.7.7/templates/SSO/aws-sso.njk
  TemplatingContext: {}
  StackName: !Sub '${resourcePrefix}-${appName}-security-auditor'
  StackDescription: 'Role used by Security Auditor group within whole organization'
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: '*'
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref securityAuditorGroup
    permissionSetName: 'SecurityAuditor'
    managedPolicies:
      - 'arn:aws:iam::aws:policy/SecurityAudit'
      - 'arn:aws:iam::aws:policy/job-function/SupportUser'
      - 'arn:aws:iam::aws:policy/AmazonInspector2ReadOnlyAccess'
      - 'arn:aws:iam::aws:policy/AWSSecurityHubReadOnlyAccess'
      - 'arn:aws:iam::aws:policy/AWSElasticBeanstalkReadOnly'
      - 'arn:aws:iam::aws:policy/AWSBillingReadOnlyAccess'
      - 'arn:aws:iam::aws:policy/AmazonMacieReadOnlyAccess'
    sessionDuration: 'PT1H'
    masterAccountId: !Ref MasterAccount

SsoViewer:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.5.1/templates/SSO/aws-sso.njk
  TemplatingContext:
    customerManagedPolicies:
      - Name: !Ref CostExplorerPolicyName
  StackName: !Sub '${resourcePrefix}-${appName}-viewer'
  StackDescription: 'Read-only role used by Admin group within whole organization'
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: '*'
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref adminGroup
    permissionSetName: 'Viewer'
    managedPolicies:
      - 'arn:aws:iam::aws:policy/job-function/ViewOnlyAccess'
      - 'arn:aws:iam::aws:policy/AWSBillingReadOnlyAccess'
    sessionDuration: 'PT12H'
    masterAccountId: !Ref MasterAccount

SsoS3Viewer:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.5.1/templates/SSO/aws-sso.njk
  TemplatingContext:
    customerManagedPolicies:
      - Name: !Ref CostExplorerPolicyName
  StackName: !Sub '${resourcePrefix}-${appName}-s3-viewer'
  StackDescription: 'S3 Read-only role to allowing access to S3 objects'
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: '*'
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref adminGroup
    permissionSetName: 'S3Viewer'
    managedPolicies:
      - 'arn:aws:iam::aws:policy/job-function/ViewOnlyAccess'
      - 'arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess'
      - 'arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess'
    sessionDuration: 'PT12H'
    masterAccountId: !Ref MasterAccount

SsoViewerPlus:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.5.1/templates/SSO/aws-sso.njk
  TemplatingContext:
    customerManagedPolicies:
      - Name: !Ref CostExplorerPolicyName
  StackName: !Sub '${resourcePrefix}-${appName}-viewer-plus'
  StackDescription: 'Read-only role with access to additional services'
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: '*'
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref adminGroup
    permissionSetName: 'viewer-plus'
    sessionDuration: 'PT12H'
    masterAccountId: !Ref MasterAccount
    managedPolicies:
      - arn:aws:iam::aws:policy/job-function/ViewOnlyAccess
      - arn:aws:iam::aws:policy/job-function/SupportUser
      - arn:aws:iam::aws:policy/AmazonDocDBReadOnlyAccess
      - arn:aws:iam::aws:policy/AWSElasticBeanstalkReadOnly
      - arn:aws:iam::aws:policy/CloudWatchLogsReadOnlyAccess
      - arn:aws:iam::aws:policy/AWSLambda_ReadOnlyAccess
      - arn:aws:iam::aws:policy/AWSBillingReadOnlyAccess
      - arn:aws:iam::aws:policy/AWSNetworkManagerReadOnlyAccess
      - arn:aws:iam::aws:policy/AWSOrganizationsReadOnlyAccess
    inlinePolicy: >-
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "IpamReadOnlyAccess",
            "Effect": "Allow",
            "Action": [
              "ec2:GetIpam*",
              "ec2:DescribeIpam*"
            ],
            "Resource": "*"
          }
        ]
      }

# Role for a user that manages an application deployed to AWS
SsoApplicationManager:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.5.1/templates/SSO/aws-sso.njk
  TemplatingContext: {}
  StackName: !Sub '${resourcePrefix}-${appName}-application-manager'
  StackDescription: 'Read-only role plus access to secrets manager'
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: '*'
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref adminGroup # by default we admit admin's.  Below we 'inherit' this stack for specific user groups
    permissionSetName: 'application-manager'
    sessionDuration: 'PT12H'
    masterAccountId: !Ref MasterAccount
    managedPolicies:
      - arn:aws:iam::aws:policy/job-function/ViewOnlyAccess
      - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
      - arn:aws:iam::aws:policy/SecretsManagerReadWrite
      - arn:aws:iam::aws:policy/AWSCertificateManagerReadOnly
    inlinePolicy: >-
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "ExecuteEcsTasks",
            "Effect": "Allow",
            "Action": [
              "ecs:RunTask",
              "ecs:StartTask"
            ],
            "Resource": "*"
          }
        ]
      }

# Role for a user that can only access AWS Athena in the Synapse Dev account
SsoSynapseDWDevAthenaUser:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.5.1/templates/SSO/aws-sso.njk
  TemplatingContext:
    customerManagedPolicies:
      - Name: SynapseAthenaUserAccessPolicy
  StackName: !Sub '${resourcePrefix}-${appName}-synapse-dw-dev-athena-user'
  StackDescription: 'Access to AWS Athena in Synapse Dev account'
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref SynapseDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref synapseDevAthenaGroup
    sessionDuration: 'PT12H'
    masterAccountId: !Ref MasterAccount
    permissionSetName: 'synapse-dw-athena-dev'

# Role for a user that can only access AWS Athena in the Synapse Prod account
SsoSynapseDWProdAthenaUser:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.5.1/templates/SSO/aws-sso.njk
  TemplatingContext:
    customerManagedPolicies:
      - Name: SynapseAthenaUserAccessPolicy
  StackName: !Sub '${resourcePrefix}-${appName}-synapse-dw-prod-athena-user'
  StackDescription: 'Access to AWS Athena in Synapse Prod account'
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref SynapseProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref synapseProdAthenaGroup
    sessionDuration: 'PT12H'
    masterAccountId: !Ref MasterAccount
    permissionSetName: 'synapse-dw-athena-prod'

SsoViewerSupporter:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-viewer-supporter'
  StackDescription: 'Read-only role used by Supporter group within Production organizational units'
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      OrganizationalUnit:
        - !Ref ScienceDevOU
        - !Ref ScienceProdOU
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scienceSupporterGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-permission-set-arn' ]

scicompViewer:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-scicomp-viewer'
  StackDescription: 'SSO: viewer role used by scicomp viewer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ScicompAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scicompViewerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-plus-permission-set-arn' ]

scicompDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-scicomp-developer'
  StackDescription: 'SSO: Developer role used by scicomp developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ScicompAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scicompDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoMobileHealthDataEngineeringDevAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-mobilehealth-dataengineering-dev-admin'
  StackDescription: 'SSO: Administrator role used by mobileHealth data engineering admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref MobileHealthDataEngineeringDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref mobileHealthDataEngineeringDevAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoMobileHealthDataEngineeringDevViewer:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-mobilehealth-dataengineering-dev-viewer'
  StackDescription: 'SSO: Viewer role used by mobileHealth data engineering viewer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref MobileHealthDataEngineeringDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref mobileHealthDataEngineeringDevViewerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-permission-set-arn' ]

SsoMobileHealthDataEngineeringProdAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-mobilehealth-dataengineering-prod-admin'
  StackDescription: 'SSO: Administrator role used by mobileHealth data engineering admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref MobileHealthDataEngineeringProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref mobileHealthDataEngineeringProdAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoMobileHealthDataEngineeringProdViewer:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-mobilehealth-dataengineering-prod-viewer'
  StackDescription: 'SSO: Viewer role used by mobileHealth data engineering viewer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref MobileHealthDataEngineeringProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref mobileHealthDataEngineeringProdViewerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-permission-set-arn' ]

SsoWorkflowNextflowDevAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-workflow-nextflow-dev-admin'
  StackDescription: 'SSO: Administrator role used by workflow nextflow admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref WorkflowsNextflowDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref workflowNextflowDevAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoWorkflowNextflowDevDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-workflow-nextflow-dev-developer'
  StackDescription: 'SSO: Developer role used by workflow nextflow developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref WorkflowsNextflowDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref workflowNextflowDevDeveloperGroup
    permissionSetName: 'Developer-IAM-Contrained'
    managedPolicies: [ 'arn:aws:iam::aws:policy/PowerUserAccess' ]
    inlinePolicy: >-
      {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Sid": "ResourceConstrainedIAM",
                  "Effect": "Allow",
                  "Action": "iam:*",
                  "Resource": [
                      "arn:aws:iam::035458030717:user/dev-*",
                      "arn:aws:iam::035458030717:role/dev-*",
                      "arn:aws:iam::035458030717:group/dev-*",
                      "arn:aws:iam::035458030717:instance-profile/dev-*",
                      "arn:aws:iam::035458030717:policy/dev-*"
                  ]
              },
              {
                  "Effect": "Deny",
                  "Action": "sts:AssumeRole",
                  "Resource": "*"
              }
          ]
      }

SsoWorkflowNextflowTowerViewer:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-workflow-nextflow-tower-viewer'
  StackDescription: 'SSO: Limited viewer role used by workflow nextflow tower viewer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account:
        - !Ref WorkflowsNextflowDevAccount
        - !Ref WorkflowsNextflowProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref workflowNextflowTowerViewerGroup
    permissionSetName: 'TowerViewer'
    sessionDuration: 'PT12H'
    inlinePolicy: >-
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "TowerViewOnlyAccess",
            "Action": [
              "batch:ListJobs"
            ],
            "Effect": "Allow",
            "Resource": "*"
          }
        ]
      }

SsoWorkflowNextflowProdAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-workflow-nextflow-prod-admin'
  StackDescription: 'SSO: Administrator role used by workflow nextflow admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref WorkflowsNextflowProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref workflowNextflowProdAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoSynapseDevAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-synapsedev-admin'
  StackDescription: 'SSO: admin role used by synapsedev admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref SynapseDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref synapseDevAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoSynapseProdAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-synapseprod-admin'
  StackDescription: 'SSO: admin role used by synapseprod admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref SynapseProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref synapseProdAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoSynapseDevDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-synapsedev-developer'
  StackDescription: 'SSO: developer role used by synapsedev developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref SynapseDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref synapseDevDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoSynapseProdDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-synapseprod-developer'
  StackDescription: 'SSO: developer role used by synapseprod developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref SynapseProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref synapseProdDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoSynapseProdViewer:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-synapseprod-viewer'
  StackDescription: 'SSO: viewer role used by synapseprod developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref SynapseProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref synapseProdViewerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-permission-set-arn' ]

SsoImageCentralAmiLibrarian:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-imagecentral-ami-librarian'
  StackDescription: 'SSO: librarian role used by imagecentral AMI librarian group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ImageCentralAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref imageCentralAmiLibrarianGroup
    permissionSetName: 'AMI-Librarian'
    managedPolicies:
      - 'arn:aws:iam::aws:policy/AmazonEC2FullAccess'
      - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'
    sessionDuration: 'PT12H'

SsoBridgeDevAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-bridgedev-admin'
  StackDescription: 'SSO: admin role used by bridgedev admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref BridgeDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref bridgeDevAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoBridgeProdAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-bridgeprod-admin'
  StackDescription: 'SSO: admin role used by bridgeprod admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref BridgeProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref bridgeProdAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoBridgeDevDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-bridgedev-developer'
  StackDescription: 'SSO: developer role used by bridgedev developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref BridgeDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref bridgeDevDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoBridgeProdDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-bridgeprod-developer'
  StackDescription: 'SSO: developer role used by bridgeprod developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref BridgeProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref bridgeProdDeveloperGroup
    permissionSetName: 'Developer-Deny-Delete-Rds-Dynamo'
    managedPolicies: [ 'arn:aws:iam::aws:policy/PowerUserAccess' ]
    sessionDuration: 'PT8H'
    inlinePolicy: >-
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Deny",
            "Action": [
              "rds:DeleteDBCluster",
              "rds:DeleteDBClusterSnapshot",
              "rds:DeleteDBInstance",
              "rds:DeleteDBSnapshot",
              "dynamodb:UpdateTable",
              "dynamodb:DeleteTable"
            ],
            "Resource": "*"
          },
          {
              "Effect": "Deny",
              "Action": "sts:AssumeRole",
              "Resource": "*"
          }
        ]
      }

SsoBridgeProdIosDeveloper:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-bridgeprod-ios-developer'
  StackDescription: 'SSO: developer role used by bridge prod ios developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref BridgeProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref bridgeProdIosDeveloperGroup
    permissionSetName: 'iOS-Developer'
    sessionDuration: 'PT8H'
    inlinePolicy: >-
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "ListBucketAccess",
            "Action": [ "s3:ListAllMyBuckets" ],
            "Effect": "Allow",
            "Resource": "arn:aws:s3:::*"
          },
          {
            "Sid": "LocationBucketAccess",
            "Action": [ "s3:ListBucket", "s3:GetBucketLocation" ],
            "Effect": "Allow",
            "Resource": "arn:aws:s3:::ios-apps.sagebridge.org"
          },
          {
            "Sid": "BucketObjectAccess",
            "Action": [ "s3:PutObject", "s3:PutObjectAcl", "s3:GetObject", "s3:GetObjectAcl", "s3:DeleteObject" ],
            "Effect": "Allow",
            "Resource": "arn:aws:s3:::ios-apps.sagebridge.org/*"
          }
        ]
      }

SsoBridgeParticipantManager:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-bridge-participant-manager'
  StackDescription: 'SSO: role used by participant managers in bridge accounts'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account:
        - !Ref BridgeDevAccount
        - !Ref BridgeProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref bridgeParticipantManagerGroup
    permissionSetName: 'bridge-participant-manager'
    managedPolicies:
      - arn:aws:iam::aws:policy/job-function/ViewOnlyAccess
      - arn:aws:iam::aws:policy/CloudWatchLogsReadOnlyAccess
      - arn:aws:iam::aws:policy/AmazonSNSReadOnlyAccess
    sessionDuration: 'PT8H'
    inlinePolicy: >-
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "SnsOptInOutAccess",
            "Action": [ "sns:CheckIfPhoneNumberIsOptedOut", "sns:OptInPhoneNumber" ],
            "Effect": "Allow",
            "Resource": "*"
          }
        ]
      }

SsoScipoolDevAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-scipooldev-admin'
  StackDescription: 'SSO: admin role used by scipooldev admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ScipoolDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scipoolDevAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoScipoolProdAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-scipoolprod-admin'
  StackDescription: 'SSO: admin role used by scipoolprod admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ScipoolProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scipoolProdAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoScipoolDevCommunityManager:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-scipooldev-community-manager'
  StackDescription: 'SSO: community manager role used by scipooldev community manager group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ScipoolDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scipoolDevCommunityManagerGroup
    permissionSetName: 'Community-Manager'
    managedPolicies: [ 'arn:aws:iam::aws:policy/AWSSupportAccess' ]
    sessionDuration: 'PT12H'
    inlinePolicy: >-
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": [
              "billing:GetBilling*",
              "consolidatedbilling:Get*",
              "consolidatedbilling:List*",
              "cur:DescribeReportDefinitions",
              "cur:PutReportDefinition",
              "cur:DeleteReportDefinition",
              "cur:ModifyReportDefinition",
              "freetier:Get*"
            ],
            "Resource": "*"
          }
        ]
      }

SsoScipoolProdCommunityManager:
  Type: update-stacks
  DependsOn: [ SsoScipoolDevCommunityManager ]
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-scipoolprod-community-manager'
  StackDescription: 'SSO: community manager role used by scipooldev community manager group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ScipoolProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scipoolProdCommunityManagerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-scipooldev-community-manager-permission-set-arn' ]

SsoAdminCentralCfnDeployer:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-admincentral-cfn-deployer'
  StackDescription: 'SSO: deployer role used by admincental CFN deployer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref AdminCentralAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref adminCentralCfnDeployerGroup
    permissionSetName: 'Cloudformation-Deployer'
    sessionDuration: 'PT12H'
    inlinePolicy: >-
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": [ "s3:ListAllMyBuckets" ],
            "Resource": "arn:aws:s3:::*"
          },
          {
            "Effect": "Allow",
            "Action": [ "s3:ListBucket", "s3:GetBucketLocation", "s3:getBucketVersioning" ],
            "Resource": [
              "arn:aws:s3:::bootstrap-awss3cloudformationbucket-19qromfd235z9",
              "arn:aws:s3:::essentials-awss3lambdaartifactsbucket-x29ftznj6pqw"
            ]
          },
          {
            "Effect": "Allow",
            "Action": [ "s3:PutObject", "s3:PutObjectAcl", "s3:GetObject", "s3:GetObjectAcl", "s3:DeleteObject" ],
            "Resource": [
              "arn:aws:s3:::bootstrap-awss3cloudformationbucket-19qromfd235z9/*",
              "arn:aws:s3:::essentials-awss3lambdaartifactsbucket-x29ftznj6pqw/*"
            ]
          },
          {
            "Sid": "ManageServerlessRepo",
            "Effect": "Allow",
            "Action": [ "serverlessrepo:*" ],
            "Resource": [
              "arn:aws:serverlessrepo:us-east-1:745159704268:applications/*"
            ]
          }
        ]
      }

SsoHtanDevAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-htan-dev-admin'
  StackDescription: 'SSO: Administrator role used by htan dev admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref HtanDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref htanDevAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoBmgfkiAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-bmgf-admin'
  StackDescription: 'SSO: admin role used by BMGF KI admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref BmgfkiAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref bmgfkiAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoBmgfkiCommunityManager:
  Type: update-stacks
  DependsOn: [ SsoScipoolDevCommunityManager ]
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-bmgfki-community-manager'
  StackDescription: 'SSO: community manager role used by BMGF KI community manager group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref BmgfkiAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref bmgfkiCommunityManagerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-scipooldev-community-manager-permission-set-arn' ]

SsoCnbAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-cnb-admin'
  StackDescription: 'SSO: Administrator role used by CNB admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref CnbAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref cnbAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoScicompIncludeDccCollab:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-scicomp-include-dcc-collab'
  StackDescription: 'SSO: role to access INCLUDE DCC project resources at CHOP'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ScicompAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scicompIncludeDccCollabGroup
    permissionSetName: 'IncludeDccCollab'
    sessionDuration: 'PT12H'
    # policy derived from https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html#vpc-endpoints-policies-s3
    # Restricting access to buckets in a specific AWS account
    managedPolicies: [ 'arn:aws:iam::aws:policy/AmazonS3FullAccess' ]
    inlinePolicy: >-
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Deny",
            "Action": "*",
            "Resource": "*",
            "Condition": {
              "ForAnyValue:StringNotLike": {
                  "s3:ResourceAccount": [
                      "373997854230",
                      "232196027141",
                      "538745987955"
                  ]
              }
            }
          }
        ]
      }

# allows users full access to s3 in other AWS accounts while also denying access to s3 in the identitycentral account.
SsoIdentityCentralS3ExternalCollab:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-identitycentral-s3-external-collab'
  StackDescription: 'SSO: role to allow s3 cross account access to other accounts'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref IdentityCentralAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref identityCentralS3ExternalCollabGroup
    permissionSetName: 'S3ExternalCollab'
    sessionDuration: 'PT12H'
    managedPolicies: [ 'arn:aws:iam::aws:policy/AmazonS3FullAccess' ]
    inlinePolicy: !Join ["", ['{"Version":"2012-10-17","Statement":[{"Effect":"Deny","Action":"*","Resource":"*","Condition":{"ForAnyValue:StringEquals":{"s3:ResourceAccount":["', !Ref IdentityCentralAccount, '"]}}}]}']]

SsoAgoraProdAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.2.11/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-agoraprod-admin'
  StackDescription: 'SSO: admin role used by agoraprod admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref AgoraProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref agoraProdAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoAgoraProdDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.2.11/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-agoraprod-developer'
  StackDescription: 'SSO: developer role used by agoraprod developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref AgoraProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref agoraProdDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoAgoraDevAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.2.11/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-agoradev-admin'
  StackDescription: 'SSO: admin role used by agoradev admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref AgoraDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref agoraDevAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoAgoraDevDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.2.11/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-agoradev-developer'
  StackDescription: 'SSO: developer role used by agoradev developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref AgoraDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref agoraDevDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoIncludeChopProdAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.2.11/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-includechopprod-admin'
  StackDescription: 'SSO: admin role used by includechopprod admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref IncludeChopProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref includeChopProdAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoIncludeChopProdDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.2.11/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-includechopprod-developer'
  StackDescription: 'SSO: developer role used by includechopprod developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref IncludeChopProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref includeChopProdDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoDntDevAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.2.11/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-dntdev-admin'
  StackDescription: 'SSO: admin role used by dntdev admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref DnTDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref dnTDevAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoDntDevDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.2.11/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-dntdev-developer'
  StackDescription: 'SSO: developer role used by dntdev developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref DnTDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref dnTDevDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoDntDevViewer:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-dntdev-viewer'
  StackDescription: 'SSO: viewer role used by  dntdev viewer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref DnTDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref dntDevViewerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-permission-set-arn' ]

SsoDntDevApplicationManager:
  Type: update-stacks
  DependsOn: SsoApplicationManager
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.5.1/templates/SSO/aws-sso.njk
  TemplatingContext: {}
  StackName: !Sub '${resourcePrefix}-${appName}-dntdev-application-manager'
  StackDescription: 'SSO: Application Manager role used by DntDev application-manager group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref DnTDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref dntDevApplicationManagerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-application-manager-permission-set-arn' ]

SsoBuA2aDwAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.2.11/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-BuA2aDw-admin'
  StackDescription: 'SSO: admin role used by BuA2aDw admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref  BuA2aDwAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref BuA2aDwAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoBWmErzkAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.2.11/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-BWmErzk-admin'
  StackDescription: 'SSO: admin role used by BWmErzk admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref  BWmErzkAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref BWmErzkAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoRecoverDevAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-recover-dev-admin'
  StackDescription: 'SSO: Administrator role used by recover admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref RecoverDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref recoverDevAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoRecoverDevDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-recover-dev-developer'
  StackDescription: 'SSO: Developer role used by recover developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref RecoverDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref recoverDevDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoRecoverDevViewer:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-recover-dev-viewer'
  StackDescription: 'SSO: Viewer role used by recover viewer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref RecoverDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref recoverDevViewerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-permission-set-arn' ]

SsoRecoverProdAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-recover-prod-admin'
  StackDescription: 'SSO: Administrator role used by recover admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref RecoverProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref recoverProdAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoRecoverProdDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-recover-prod-developer'
  StackDescription: 'SSO: Developer role used by recover developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref RecoverProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref recoverProdDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoRecoverProdViewer:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-recover-prod-viewer'
  StackDescription: 'SSO: Viewer role used by recover viewer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref RecoverProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref recoverProdViewerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-permission-set-arn' ]

# IT-3403: Allow digital analytics team to download from S3 buckets
SsoRecoverDigitalHealthAnalytics:
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-recover-digital-health-analytics'
  StackDescription: 'SSO: role used by the digital health analytics group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account:
        - !Ref RecoverDevAccount
        - !Ref RecoverProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref recoverDigitalHealthAnalyticsGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-s3-viewer-permission-set-arn' ]

SsoDCAProdViewer:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-dca-prod-viewer'
  StackDescription: 'SSO: Viewer role used by DCA viewer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref DCAProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref dcaProdViewersGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-permission-set-arn' ]

SsoDCAProdViewerPlus:
  Type: update-stacks
  DependsOn: SsoViewerPlus
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-dca-prod-viewer-plus'
  StackDescription: 'SSO: Viewer Plus role used by DCA viewer-plus group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref DCAProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref dcaProdViewersPlusGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-plus-permission-set-arn' ]

SsoDCAProdApplicationManager:
  Type: update-stacks
  DependsOn: SsoApplicationManager
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.5.1/templates/SSO/aws-sso.njk
  TemplatingContext: {}
  StackName: !Sub '${resourcePrefix}-${appName}-dca-prod-application-manager'
  StackDescription: 'SSO: Application Manager role used by DCA application-manager group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref DCAProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref dcaProdApplicationManagerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-application-manager-permission-set-arn' ]

SsoGenieProdViewer:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-genie-prod-viewer'
  StackDescription: 'SSO: Viewer role used by Genie viewer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref GenieProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref genieProdViewerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-permission-set-arn' ]

SsoGenieProdViewerPlus:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-genie-prod-viewer-plus'
  StackDescription: 'SSO: Viewer role used by Genie viewer-plus group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref GenieProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref genieProdViewerPlusGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-plus-permission-set-arn' ]

SsoGenieProdApplicationManager:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-genie-prod-application-manager'
  StackDescription: 'SSO: Application Manager role used by Genie application-manager group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref GenieProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref genieProdApplicationManagerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-application-manager-permission-set-arn' ]

SsoDpeProdAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-dpe-prod-admin'
  StackDescription: 'SSO: Administrator role used by DPE admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref DpeProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref dpeProdAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoDpeProdDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-dpe-prod-developer'
  StackDescription: 'SSO: Developer role used by DPE developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref DpeProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref dpeProdDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoDpeProdViewer:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-dpe-prod-viewer'
  StackDescription: 'SSO: Viewer role used by DPE viewer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref DpeProdAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref dpeProdViewerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-permission-set-arn' ]

SsoIpamViewerPlus:
  Type: update-stacks
  DependsOn: SsoViewerPlus
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-ipam-viewer-plus'
  StackDescription: 'SSO: Viewer role used by ipam viewer plus group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref IpamAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref ipamViewerPlusGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-plus-permission-set-arn' ]

SsoMonitorCentralViewerPlus:
  Type: update-stacks
  DependsOn: SsoViewerPlus
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.5.1/templates/SSO/aws-sso.njk
  TemplatingContext: {}
  StackName: !Sub '${resourcePrefix}-${appName}-monitorcental-viewer-plus'
  StackDescription: 'SSO: Viewer role used by monitorcentral viewer plus group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref MonitorCentralAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref monitorCentralViewerPlusGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-plus-permission-set-arn' ]

SsoScceDevAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-sccedev-admin'
  StackDescription: 'SSO: Viewer role used by SCCE dev admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ScceDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scceDevAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

scceDevDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-sccedev-developer'
  StackDescription: 'SSO: Viewer role used by SCCE dev developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ScceDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scceDevDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoScceDevViewer:
  Type: update-stacks
  DependsOn: SsoViewer
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-sccedev-viewer'
  StackDescription: 'SSO: Viewer role used by SCCE dev viewer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ScceDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scceDevViewerGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-permission-set-arn' ]

SsoScceDevViewerPlus:
  Type: update-stacks
  DependsOn: SsoViewerPlus
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-sccedev-viewer-plus'
  StackDescription: 'SSO: Viewer role used by SCCE dev viewer plus group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ScceDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref scceDevViewerPlusGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-viewer-plus-permission-set-arn' ]

SsoCnbDevAdmin:
  Type: update-stacks
  DependsOn: SsoAdministrator
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-cnb-dev-admin'
  StackDescription: 'SSO role used by CnB-dev admin group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref CnbDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref cnbDevAdminGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-admin-permission-set-arn' ]

SsoCnbDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-cnb-dev-developer'
  StackDescription: 'SSO role used by CnB-dev developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref CnbDevAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref cnbDevDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]

SsoItsandboxDeveloper:
  Type: update-stacks
  DependsOn: SsoDeveloper
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/v0.3.8/templates/SSO/aws-sso.yaml
  StackName: !Sub '${resourcePrefix}-${appName}-itsandbox-developer'
  StackDescription: 'SSO role used by itsandbox developer group'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: !Ref ITSandboxAccount
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref itsandboxDeveloperGroup
    permissionSetArn: !CopyValue [ !Sub '${resourcePrefix}-${appName}-developer-permission-set-arn' ]
