AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  ClientIdList:
    Type: List<String>
    Description: >-
      A list of client IDs (also known as audiences) that are associated with
      the specified IAM OIDC provider resource object
    Default: "sts.amazonaws.com"
  ThumbprintList:
    Type: List<String>
    Description: >-
      A list of certificate thumbprints that are associated with the specified
      IAM OIDC provider resource object
  Url:
    Type: String
    Description: "The URL that the IAM OIDC provider resource object is associated with"
    Default: "https://token.actions.githubusercontent.com"
  GitHubOrg:
    Type: String
    Description: "The name of the github organization"
Resources:
  Provider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      ClientIdList: !Ref ClientIdList
      ThumbprintList: !Ref ThumbprintList
      Url: !Ref Url
{% for Repository in Repositories %}
  ProviderRole{{ Repository.repo | replace('-','') | replace('_','') }}:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action: sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !Ref Provider
            Condition:
              StringLike:
                token.actions.githubusercontent.com:sub: !Sub repo:${GitHubOrg}/{{ Repository.repo }}:*
              ForAllValues:StringEquals:
                token.actions.githubusercontent.com:aud: !Ref ClientIdList
                token.actions.githubusercontent.com:sub: !Sub repo:${GitHubOrg}/{{ Repository.repo }}:ref:refs/heads/{{ Repository.branch }}
{% endfor %}
Outputs:
  ProviderArn:
    Value: !Ref Provider
    Export:
      Name: !Sub '${AWS::Region}-${AWS::StackName}-ProviderArn'
{% for Repository in Repositories %}
  ProviderRoleArn{{ Repository.repo | replace('-','') | replace('_','') }}:
    Value: !GetAtt ProviderRole{{ Repository.repo | replace('-','') | replace('_','') }}.Arn
    Export:
      Name: !Sub '${AWS::Region}-${AWS::StackName}-ProviderRoleArn-{{ Repository.repo | replace('-','') | replace('_','') }}'
{% endfor %}
