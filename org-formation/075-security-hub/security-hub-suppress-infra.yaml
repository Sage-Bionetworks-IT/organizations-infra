Transform: AWS::Serverless-2016-10-31
Description: >-
  Provision queues, policies and a lambda to support automatic suppression of Security Hub findings.
  See https://aws.amazon.com/blogs/security/how-to-create-auto-suppression-rules-in-aws-security-hub/ for
  more details.
Parameters:
  AccessToQueueUserArnList:
    Type: List<String>
    Description: A list of users' ARNs that can access the findings queue
Resources:
  SecurityHubBatchUpdateSuppressionManagedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Statement:
        - Action:
          - logs:CreateLogGroup
          Effect: Allow
          Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
          Sid: CloudWatchLogs1
        - Action:
          - logs:CreateLogStream
          - logs:PutLogEvents
          Effect: Allow
          Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/SecurityHubFindingsSuppressionLambdaFct:*"
          Sid: CloudWatchLogs2
        - Action: securityhub:BatchUpdateFindings
          Effect: Allow
          Resource: "*"
          Sid: SecurityHubBatchUpdateFindings
        Version: '2012-10-17'
      Description: Suppression policy for Security Hub implementing batch update findings
      Path: "/"
  SecurityHubBatchUpdateSuppressionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action: sts:AssumeRole
          Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
        Version: '2012-10-17'
      Description: Suppression role for Security Hub batch update findings
      ManagedPolicyArns:
      - Ref: SecurityHubBatchUpdateSuppressionManagedPolicy
      Path: "/"
  SecurityHubBatchUpdateSuppressionRoleDefaultPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
        - Action: kms:Decrypt
          Effect: Allow
          Resource:
            Fn::GetAtt:
            - SqsEncryptionKey
            - Arn
        - Action:
          - sqs:ReceiveMessage
          - sqs:ChangeMessageVisibility
          - sqs:GetQueueUrl
          - sqs:DeleteMessage
          - sqs:GetQueueAttributes
          Effect: Allow
          Resource:
            Fn::GetAtt:
            - SecurityHubFindingsQueue
            - Arn
        Version: '2012-10-17'
      PolicyName: SecurityHubBatchUpdateSuppressionRoleDefaultPolicy
      Roles:
      - Ref: SecurityHubBatchUpdateSuppressionRole
  SecurityHubFindingsQueueAccessRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action: sts:AssumeRole
          Effect: Allow
          Principal:
            AWS: !Ref AccessToQueueUserArnList
        Version: '2012-10-17'
      Description: Access to encrypted queue for SSO roles
      Path: "/"
  SecurityHubFindingsQueueAccessRoleDefaultPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
        - Action: kms:Decrypt
          Effect: Allow
          Resource:
            Fn::GetAtt:
            - SqsEncryptionKey
            - Arn
        Version: '2012-10-17'
      PolicyName: SecurityHubFindingsQueueAccessRoleDefaultPolicy
      Roles:
      - Ref: SecurityHubFindingsQueueAccessRole
  SqsEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy:
        Statement:
        - Action:
          - kms:Create*
          - kms:Describe*
          - kms:Enable*
          - kms:List*
          - kms:Put*
          - kms:Update*
          - kms:Revoke*
          - kms:Disable*
          - kms:Get*
          - kms:Delete*
          - kms:ScheduleKeyDeletion
          - kms:CancelKeyDeletion
          - kms:GenerateDataKey
          - kms:TagResource
          - kms:UntagResource
          Effect: Allow
          Principal:
            AWS:
              Fn::Join:
              - ''
              - - 'arn:'
                - Ref: AWS::Partition
                - ":iam::"
                - Ref: AWS::AccountId
                - ":root"
          Resource: "*"
        - Action: kms:Decrypt
          Effect: Allow
          Principal:
            AWS:
              Fn::GetAtt:
              - SecurityHubBatchUpdateSuppressionRole
              - Arn
          Resource: "*"
        - Action:
          - kms:Decrypt
          - kms:Encrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          Effect: Allow
          Principal:
            Service: events.amazonaws.com
          Resource: "*"
        Version: '2012-10-17'
      EnableKeyRotation: true
      PendingWindowInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  SqsEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/SQSEncryptionKey
      TargetKeyId:
        Fn::GetAtt:
        - SqsEncryptionKey
        - Arn
  SecurityhubFindingsDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId:
        Fn::GetAtt:
        - SqsEncryptionKey
        - Arn
      MessageRetentionPeriod: 172800
      VisibilityTimeout: 130
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  SecurityHubFindingsDeadLetterQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Statement:
        - Action: sqs:*
          Condition:
            Bool:
              aws:secureTransport: 'false'
          Effect: Deny
          Principal: "*"
          Resource:
            Fn::GetAtt:
            - SecurityhubFindingsDeadLetterQueue
            - Arn
          Sid: Enforce TLS for all principals
        Version: '2012-10-17'
      Queues:
      - Ref: SecurityhubFindingsDeadLetterQueue
  SecurityHubFindingsQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId:
        Fn::GetAtt:
        - SqsEncryptionKey
        - Arn
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - SecurityhubFindingsDeadLetterQueue
          - Arn
        maxReceiveCount: 1
      VisibilityTimeout: 130
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  SecurityHubFindingsQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Statement:
        - Action: sqs:*
          Condition:
            Bool:
              aws:secureTransport: 'false'
          Effect: Deny
          Principal: "*"
          Resource:
            Fn::GetAtt:
            - SecurityHubFindingsQueue
            - Arn
          Sid: Enforce TLS for all principals
        - Action:
          - sqs:SendMessage
          - sqs:GetQueueAttributes
          - sqs:GetQueueUrl
          Effect: Allow
          Principal:
            Service: events.amazonaws.com
          Resource:
            Fn::GetAtt:
            - SecurityHubFindingsQueue
            - Arn
        Version: '2012-10-17'
      Queues:
      - Ref: SecurityHubFindingsQueue

  AWSLambdaPowertoolsApplication:
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:eu-west-1:057560766410:applications/aws-lambda-powertools-python-layer
        SemanticVersion: 2.5.0
    Metadata:
      aws:cdk:path: sechub-finding-suppression/AWSLambdaPowertoolsApplication
  SecurityHubFindingsSuppressionLambdaFct:
    Type: AWS::Lambda::Function
    DependsOn: SecurityHubBatchUpdateSuppressionRole
    Properties:
      Code:
        ZipFile: |
          import json, boto3
          import botocore.exceptions as boto3exceptions

          from aws_lambda_powertools.utilities.batch import BatchProcessor, EventType
          from aws_lambda_powertools import Logger
          from aws_lambda_powertools.utilities.typing import LambdaContext

          logger =  Logger()

          sh_client = boto3.client("securityhub")

          """
          Used by the lambda to tracks all of the Security Hub finding ids that will be suppressed.
          Each Lambda invocation will create a separate instance of this class.
          """
          class RecordsHandler:
              def __init__(self):
                  self.finding_identifiers = []

              def record_handler(self, record):
                  payload = json.loads(record["body"])
                  logger.info(f"payload {payload}")
                  finding_identifier = {
                      "Id": payload["detail"]["findings"][0]["Id"],
                      "ProductArn": payload["detail"]["findings"][0]["ProductArn"],
                  }
                  self.finding_identifiers.append(finding_identifier)

              def get_finding_identifiers(self):
                  return self.finding_identifiers

          """
          Uses the Lambda Powertools BatchProcessor in order to build the findings id list.
          Lambda powertools is used to prevent successfully processed messages being returned to SQS
          https://awslabs.github.io/aws-lambda-powertools-python/latest/utilities/batch/
          """
          @logger.inject_lambda_context(log_event=True)
          def handler(event, context):
              records = event["Records"]
              logger.info(f"records {records}")

              processor = BatchProcessor(event_type=EventType.SQS)

              rh = RecordsHandler()
              with processor(records, rh.record_handler) as proc:
                  proc.process()

              finding_identifiers = rh.get_finding_identifiers()
              logger.info(f"finding_identifiers {finding_identifiers}")

              try:
                  response = sh_client.batch_update_findings(
                      FindingIdentifiers=finding_identifiers,
                      Workflow={"Status": "SUPPRESSED"},
                  )
                  for processed_findings in response["ProcessedFindings"]:
                      logger.info(
                          f"processed and suppressed id {processed_findings['Id']} productarn {processed_findings['ProductArn']}"
                      )

                  for unprocessed_findings in response["UnprocessedFindings"]:
                      logger.error(
                          f"unprocessed finding id {unprocessed_findings['FindingIdentifier']['Id']} productarn {unprocessed_findings['FindingIdentifier']['ProductArn']} error code {unprocessed_findings['ErrorCode']} error message {unprocessed_findings['ErrorMessage']}"
                      )

              except boto3exceptions.ClientError as error:
                  logger.exception("client error")
                  raise ConnectionError(f"Client error invoking batch update findings {error}")
              except boto3exceptions.ParamValidationError as error:
                  logger.exception("invalid parameters")
                  raise ValueError(f"The parameters you provided are incorrect: {error}")

              return {"statusCode": 200}
      Role: !GetAtt SecurityHubBatchUpdateSuppressionRole.Arn
      FunctionName: SecurityHubFindingsSuppressionLambdaFct
      Description: Suppression lambda for Security Hub implements batch update findings
      Handler: index.handler
      Layers:
      - Fn::GetAtt:
        - AWSLambdaPowertoolsApplication
        - Outputs.LayerVersionArn
      Runtime: python3.8
      Timeout: 120
  BatchupdateEventInvokeConfig:
    Type: AWS::Lambda::EventInvokeConfig
    DependsOn: SecurityHubFindingsSuppressionLambdaFct
    Properties:
      FunctionName: !Ref SecurityHubFindingsSuppressionLambdaFct
      Qualifier: "$LATEST"
      MaximumRetryAttempts: 2
  BatchUpdateLambdaFctEventSourceEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    DependsOn: SecurityHubFindingsSuppressionLambdaFct
    Properties:
      FunctionName: !Ref SecurityHubFindingsSuppressionLambdaFct
      BatchSize: 10
      Enabled: true
      EventSourceArn: !GetAtt SecurityHubFindingsQueue.Arn
      MaximumBatchingWindowInSeconds: 10

  # Below this point, rules are defined to send findings to the SecurityHubFindingsQueue above
  # The findings on the queue will be processed by a lambda that will suppress them in SecurityHub

  # Event schema: https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cwe-event-formats.html
  # Findings schema:https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-findings-format.html

  # This rule suppresses findings for the given controls (GeneratorId) in all the accounts
  SuppressFindingsInAllAccountsRule:
    Type: AWS::Events::Rule
    Properties:
      Description: SecHubSuppress findings (identified by generatorId) for all accounts
      EventPattern:
        detail:
          findings:
            GeneratorId:
              - 'arn:aws:securityhub:::ruleset/cis-aws-foundations-benchmark/v/1.2.0/rule/4.3'
              - 'cis-aws-foundations-benchmark/v/1.4.0/5.3' # same as v/1.2.0/rule/4.3
              - 'aws-foundational-security-best-practices/v/1.0.0/EC2.2'
              - 'arn:aws:securityhub:::ruleset/cis-aws-foundations-benchmark/v/1.2.0/rule/1.14'
              - 'cis-aws-foundations-benchmark/v/1.4.0/1.6' # same as v/1.2.0/rule/1.14
              - 'aws-foundational-security-best-practices/v/1.0.0/IAM.6'
              - 'arn:aws:securityhub:::ruleset/cis-aws-foundations-benchmark/v/1.2.0/rule/2.7'
              - 'cis-aws-foundations-benchmark/v/1.4.0/3.7'
              # SecHub Recommendation: no security group allows unrestricted ingress access to port 22/3389.
              # Supression Reason: Allow for bastian hosts and testing
              - 'cis-aws-foundations-benchmark/v/1.2.0/rule/4.1'
              - 'arn:aws:securityhub:::ruleset/cis-aws-foundations-benchmark/v/1.2.0/rule/4.1'
              - 'arn:aws:securityhub:::ruleset/cis-aws-foundations-benchmark/v/1.2.0/rule/4.2'
              - 'cis-aws-foundations-benchmark/v/1.4.0/3.5'  # (IT-3619) "3.5 Ensure AWS Config is enabled in all regions"
              - 'cis-aws-foundations-benchmark/v/1.4.0/5.1'  # (IT-4190) "5.1 Ensure no Network ACLs allow ingress from 0.0.0.0/0 to remote server administration ports"
              - 'cis-aws-foundations-benchmark/v/1.4.0/2.1.5.1'  # (IT-4236) "2.1.5.1 S3 Block Public Access setting should be enabled"
            Workflow:
              Status:
              - NEW
              - NOTIFIED
        detail-type:
        - Security Hub Findings - Imported
        source:
        - aws.securityhub
      State: ENABLED
      Targets:
      - Arn:
          Fn::GetAtt:
          - SecurityHubFindingsQueue
          - Arn
        Id: Target0

  # This rule suppresses findings with the given generator IDs only for the infra resources
  SuppressFindingsForPublicBucketsRule:
    Type: AWS::Events::Rule
    Properties:
      Description: SecHubSuppress findings (identified by generatorId) for the infra resources in all accounts
      EventPattern:
        detail:
          findings:
            Resources:
              Id:
                - prefix: 'arn:aws:s3:::bootstrap-awss3cloudformationbucket-'
                - prefix: 'arn:aws:s3:::essentials-awss3lambdaartifactsbucket-'
                - prefix: 'arn:aws:s3:::cf-templates-'
                - prefix: 'arn:aws:s3:::cloudformationmanageduploadinfra'
                - prefix: 'arn:aws:s3:::cost-and-usage-reports.sagebase.org'
                # IT-4072 public Bridge buckets
                - prefix: 'arn:aws:s3:::android-apps.sagebridge.org'
                - prefix: 'arn:aws:s3:::ios-apps.sagebridge.org'
                - prefix: 'arn:aws:s3:::research.sagebridge.org'
                - prefix: 'arn:aws:s3:::research-staging.sagebridge.org'
                - prefix: 'arn:aws:s3:::admin.sagebridge.org'
                - prefix: 'arn:aws:s3:::admin-staging.sagebridge.org'
                - prefix: 'arn:aws:s3:::developer.sagebridge.org'
                - prefix: 'arn:aws:s3:::mpower.sagebridge.org'
                - prefix: 'arn:aws:s3:::smart4sure.sagebridge.org'
                - prefix: 'arn:aws:s3:::parkinsonmpower.org'
                - prefix: 'arn:aws:s3:::cfn-snippets-bucket-cloudformationsnippetsbucket-elu83sv8ocdz'
                - prefix: 'arn:aws:s3:::sagebase-rules-microservice-outputbucket-17vzcnk2xnq0'
                - prefix: 'arn:aws:s3:::sharethejourneyapp.org'
                - prefix: 'arn:aws:s3:::org-sagebridge-repo-maven-releases'
                - prefix: 'arn:aws:s3:::org-sagebridge-static-bcs'
                - prefix: 'arn:aws:s3:::org-sagebridge-static-pd'
                - prefix: 'arn:aws:s3:::org-sagebridge-teamstudy'
                - prefix: 'arn:aws:s3:::org-sagebridge-truststore'
                - prefix: 'arn:aws:s3:::org-sagebridge-ui-test'
                - prefix: 'arn:aws:s3:::web-mpower-2'
                - prefix: 'arn:aws:s3:::sage-igenomes'
                # See ticket DPE-1234
                - prefix: 'arn:aws:s3:::synapse-croissant-metadata'
                # Cloudfront buckets in org-sagebase-sageit account
                - prefix: 'arn:aws:s3:::admodelexplorer.org'
                - prefix: 'arn:aws:s3:::alzdrugtool.synapse.org'
                - prefix: 'arn:aws:s3:::aws-sso.sageit.org'
                - prefix: 'arn:aws:s3:::brainsomaticmosaicism.org'
                - prefix: 'arn:aws:s3:::csbconsortium.org'
                - prefix: 'arn:aws:s3:::designmanual.sagebase.org'
                - prefix: 'arn:aws:s3:::install.studies.mobiletoolbox.org'
                - prefix: 'arn:aws:s3:::it1363.sagebase.org'
                - prefix: 'arn:aws:s3:::mindkindstudyredirector.org'
                - prefix: 'arn:aws:s3:::mobiletoolbox.org'
                - prefix: 'arn:aws:s3:::privacytoolkit.sagebase.org'
                - prefix: 'arn:aws:s3:::privacytoolkit.sagebionetworks.org'
                - prefix: 'arn:aws:s3:::prod.bsmn.synapse.org'
                - prefix: 'arn:aws:s3:::prod.cancercomplexity.synapse.org'
                - prefix: 'arn:aws:s3:::prod.covid19patientcorps.sagebionetworks.org'
                - prefix: 'arn:aws:s3:::prod.covidrecoverycorps.org'
                - prefix: 'arn:aws:s3:::prod.covidrecoverycorpsresearcher.synapse.org'
                - prefix: 'arn:aws:s3:::prod.csbc-pson.synapse.org'
                - prefix: 'arn:aws:s3:::prod.dhealth.synapse.org'
                - prefix: 'arn:aws:s3:::prod.eliteportal.org'
                - prefix: 'arn:aws:s3:::prod.htan.synapse.org'
                - prefix: 'arn:aws:s3:::prod.mindkindstudy.org'
                - prefix: 'arn:aws:s3:::prod.mobiletoolbox.org'
                - prefix: 'arn:aws:s3:::prod.modeladexplorer.org'
                - prefix: 'arn:aws:s3:::prod.nf.synapse.org'
                - prefix: 'arn:aws:s3:::prod.psychencode.synapse.org'
                - prefix: 'arn:aws:s3:::prod.studies.mobiletoolbox.org'
                - prefix: 'arn:aws:s3:::prod.wtgmhdc.synapse.org'
                - prefix: 'arn:aws:s3:::psychencode.org'
                - prefix: 'arn:aws:s3:::sso.sageit.org'
                - prefix: 'arn:aws:s3:::staging.admodelexplorer.org'
                - prefix: 'arn:aws:s3:::staging.alzdrugtool.synapse.org'
                - prefix: 'arn:aws:s3:::staging.bsmn.synapse.org'
                - prefix: 'arn:aws:s3:::staging.cancercomplexity.synapse.org'
                - prefix: 'arn:aws:s3:::staging.covid19patientcorps.sagebionetworks.org'
                - prefix: 'arn:aws:s3:::staging.covidrecoverycorps.org'
                - prefix: 'arn:aws:s3:::staging.covidrecoverycorpsresearcher.synapse.org'
                - prefix: 'arn:aws:s3:::staging.csbc-pson.synapse.org'
                - prefix: 'arn:aws:s3:::staging.dhealth.synapse.org'
                - prefix: 'arn:aws:s3:::staging.eliteportal.org'
                - prefix: 'arn:aws:s3:::staging.htan.synapse.org'
                - prefix: 'arn:aws:s3:::staging.mindkindstudy.org'
                - prefix: 'arn:aws:s3:::staging.mobiletoolbox.org'
                - prefix: 'arn:aws:s3:::staging.modeladexplorer.org'
                - prefix: 'arn:aws:s3:::staging.nf.synapse.org'
                - prefix: 'arn:aws:s3:::staging.stopadportal.synapse.org'
                - prefix: 'arn:aws:s3:::staging.studies.mobiletoolbox.org'
                - prefix: 'arn:aws:s3:::staging.wtgmhdc.synapse.org'
                - prefix: 'arn:aws:s3:::static.ampadportal.org'
                - prefix: 'arn:aws:s3:::static.nf.synapse.org'
                - prefix: 'arn:aws:s3:::stopadportal.synapse.org'
                - prefix: 'arn:aws:s3:::test.admodeladexplorer.org'
                - prefix: 'arn:aws:s3:::vpn.sageit.org'
                - prefix: 'arn:aws:s3:::www.csbconsortium.org'
                - prefix: 'arn:aws:s3:::www.csbcpson2018.org'
                - prefix: 'arn:aws:s3:::www.elevatems.org'
                - prefix: 'arn:aws:s3:::www.journeypro.org'
                # This should only match with 2.1.5.1
                - 'AWS::::Account:140124849929'
            GeneratorId:
              - 'cis-aws-foundations-benchmark/v/1.4.0/2.1.1'
              - 'cis-aws-foundations-benchmark/v/1.4.0/2.1.5.2'
              - 'cis-aws-foundations-benchmark/v/1.4.0/2.1.5.1'
              - 'cis-aws-foundations-benchmark/v/1.4.0/2.1.2'
            Workflow:
              Status:
              - NEW
              - NOTIFIED
        detail-type:
        - Security Hub Findings - Imported
        source:
        - aws.securityhub
      State: ENABLED
      Targets:
      - Arn:
          Fn::GetAtt:
          - SecurityHubFindingsQueue
          - Arn
        Id: Target0

  # This rule suppresses findings with the given generator IDs only for the IAM accounts specified
  SuppressFindingsForIAMsRule:
    Type: AWS::Events::Rule
    Properties:
      Description: SecHubSuppress findings (identified by generatorId) for given IAM accounts in all AWS accounts
      EventPattern:
        detail:
          findings:
            Resources:
              Id:
                # synapseprod IT-2396, do not exempt human users
                - 'arn:aws:iam::325565585839:user/ran-uploader'
                # scipool IT-2315
                - prefix: 'arn:aws:iam::237179673806:user/synapse-login-scipoolprod-ServiceUser-'
            GeneratorId:
              - 'arn:aws:securityhub:::ruleset/cis-aws-foundations-benchmark/v/1.2.0/rule/1.4'
            Workflow:
              Status:
              - NEW
              - NOTIFIED
        detail-type:
        - Security Hub Findings - Imported
        source:
        - aws.securityhub
      State: ENABLED
      Targets:
      - Arn:
          Fn::GetAtt:
          - SecurityHubFindingsQueue
          - Arn
        Id: Target0

  # This rule suppresses findings in org-sagebase-imagecentral for EBS encryption since the volumes
  # in this account are used for creating public AMIs
  SuppressFindingsForPublicImagesRule:
    Type: AWS::Events::Rule
    Properties:
      Description: SecHubSuppress findings for EBS encryption
      EventPattern:
        detail:
          findings:
            Resources:
              Id:
                # image-central
                - 'AWS::::Account:867686887310'
            GeneratorId:
              # EBS encryption enabled by default
              - 'cis-aws-foundations-benchmark/v/1.4.0/2.2.1'
            Workflow:
              Status:
              - NEW
              - NOTIFIED
        detail-type:
        - Security Hub Findings - Imported
        source:
        - aws.securityhub
      State: ENABLED
      Targets:
      - Arn:
          Fn::GetAtt:
          - SecurityHubFindingsQueue
          - Arn
        Id: Target0

  # Findings to suppress in Bridge accounts.
  # * Suppress findings for insecure access to S3 buckets in the bridge accounts
  #   because consent forms are accessed internally by the app via HTTP.
  SuppressFindingsForBridgeAccounts:
    Type: AWS::Events::Rule
    Properties:
      Description: SecHubSuppress findings for Bridge accounts
      EventPattern:
        detail:
          findings:
            GeneratorId:
              # Ensure S3 Bucket Policy is set to deny HTTP requests
              - 'cis-aws-foundations-benchmark/v/1.4.0/2.1.2'
            Workflow:
              Status:
              - NEW
              - NOTIFIED
            AwsAccountId:
            - '420786776710' # bridge-dev
            - '649232250620' # bridge-prod
        detail-type:
        - Security Hub Findings - Imported
        source:
        - aws.securityhub
      State: ENABLED
      Targets:
      - Arn:
          Fn::GetAtt:
          - SecurityHubFindingsQueue
          - Arn
        Id: Target0

  # Findings to suppress for service users in Bridge accounts.
  # * Suppress findings for unused credentials because automation runs less
  #   frequently than every 45 days.
  # * Suppress findings for access key rotation because we don't know everywhere
  #   that they're used, creating a risk of a prolonged outage and data loss.
  SuppressFindingsForBridgeServiceUsers:
    Type: AWS::Events::Rule
    Properties:
      Description: SecHubSuppress findings for Bridge accounts
      EventPattern:
        detail:
          findings:
            GeneratorId:
              # Disable credentials unused for more than 45 days
              - 'cis-aws-foundations-benchmark/v/1.4.0/1.12'
              # Disable credentials unused for more than 90 days
              - 'cis-aws-foundations-benchmark/v/1.4.0/1.14'
            Resources:
              Id:
                - 'arn:aws:iam::649232250620:user/BridgeDocsAndRepoBuild'
                - 'arn:aws:iam::649232250620:user/TravisUser'
                - 'arn:aws:iam::649232250620:user/web-mpower-2-ci'
            Workflow:
              Status:
              - NEW
              - NOTIFIED
            AwsAccountId:
            - '420786776710' # bridge-dev
            - '649232250620' # bridge-prod
        detail-type:
        - Security Hub Findings - Imported
        source:
        - aws.securityhub
      State: ENABLED
      Targets:
      - Arn:
          Fn::GetAtt:
          - SecurityHubFindingsQueue
          - Arn
        Id: Target0
