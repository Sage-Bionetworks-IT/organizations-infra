AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  AWS CloudFormation template that will create an SSM Maintenance
  Window Task, with associated Maintenance Window, SSM Document,
  Target and Role to run a given script on the EC2s in the specified account.
Parameters:
  Schedule:
    Type: 'String'
    Description: 'Schedule to run script'
    Default: "rate(24 hours)"
  ScriptURL:
    Type: 'String'
    Description: 'URL for the script to run'
  ScriptParameters:
    Type: 'String'
    Description: >-
      space delimited list of key:value, where key is an SSM Parameter Store
      key and value is the shell envvar name to assign, e.g., /foo/bar:ENVVAR1 /bar/baz:ENVVAR2
  TargetAccountId:
    Type: 'String'
    Description: The target account in which to run the Maintenance Task    
Resources:
  SSMDocument:
    Type: "AWS::SSM::Document"
    Properties:
      DocumentType: "Command"
      Name: "run-parameterized-script"
      Content:
        schemaVersion: "2.2"
        description: "Run a script on EC2 instances"
        parameters:
          ScriptUrl:
            type: String
            description: "The URL of the script to run"
          Region:
            type: String
            description: The AWS region
          SsmParameterNameToEnvvarMap:
            type: String
            description: >-
              space delimited list of key:value, where key is an SSM Parameter Store
              key and value is the shell envvar name to assign, e.g., /foo/bar:ENVVAR1 /bar/baz:ENVVAR2
        mainSteps:
        - action: "aws:runShellScript"
          name: "runShellScript"
          inputs:
            runCommand:
            - sudo su root
            - SSM_TO_ENV_MAP=( {{ SsmParameterNameToEnvvarMap }} )
            - for KV in ${SSM_TO_ENV_MAP[@]} ; do
            -   export ${KV##*:}=$(aws --region {{ Region }} ssm get-parameters --names ${KV%%:*} --with-decryption --query Parameters[0].Value --output text)
            - done
            - SCRIPT_PATH=/tmp/script.sh
            - wget -O $SCRIPT_PATH {{ ScriptUrl }}
            - chmod +x $SCRIPT_PATH
            - $SCRIPT_PATH

  # Create Maintenance Window
  MaintenanceWindow:
    Type: "AWS::SSM::MaintenanceWindow"
    Properties:
      Name: "DailyMaintenanceWindow"
      Schedule: !Ref Schedule
      Duration: 1 # Duration of the maintenance window in hours
      Cutoff: 0
      AllowUnassociatedTargets: False

  # Create Maintenance Window Target
  MaintenanceWindowTarget:
    Type: "AWS::SSM::MaintenanceWindowTarget"
    Properties:
      WindowId: !Ref MaintenanceWindow
      ResourceType: "INSTANCE"
      Targets:
        - Key: "tag:scheduled-maintenance"
          Values:
            - "stack-armor"
      Name: "SSMGroupTarget"

  # Create Maintenance Window Task
  MaintenanceWindowTask:
    Type: "AWS::SSM::MaintenanceWindowTask"
    Properties:
      WindowId: !Ref MaintenanceWindow
      Targets:
        - Key: "WindowTargetIds"
          Values:
            - !Ref MaintenanceWindowTarget
      TaskArn: !Ref SSMDocument
      TaskType: "RUN_COMMAND"
      TaskInvocationParameters:
        MaintenanceWindowRunCommandParameters:
          Comment: "Running SSM document on instances"
          TimeoutSeconds: 600
          ServiceRoleArn:
            !Join [ '', ['arn:', !Ref 'AWS::Partition', ':iam::', !Ref 'TargetAccountId', ':role/AWS-SystemsManager-ScheduledMaintenanceExecutionRole'] ]
          Parameters:
            ScriptUrl: [!Ref ScriptURL]
            Region: [!Ref AWS::Region]
            SsmParameterNameToEnvvarMap: [!Ref ScriptParameters]
      Priority: 1
      MaxConcurrency: "1"
      MaxErrors: "1"
