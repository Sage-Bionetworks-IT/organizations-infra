AWSTemplateFormatVersion: 2010-09-09

Parameters:
  bucketName:
    Type: String

Resources:
  S3Bucket:
    Type: 'AWS::S3::Bucket'
    DeletionPolicy: Retain
    Properties:
      BucketName: !Ref bucketName
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
        Tags:
          - Key: "parkmycloud"
            Value: !Ref ParkMyCloudManaged
          - Key: "ManagedInstanceMaintenanceTarget"
            Value: "yes"
          - aws:cloudformation:stack-id


  BucketPolicy:
    Type: "AWS::S3::BucketPolicy"
    Properties:
      Bucket: !Ref S3Bucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: AWSCloudTrailAclCheck20150319
          Effect: Allow
          Principal:
            Service: cloudtrail.amazonaws.com
          Action: s3:GetBucketAcl
          Resource: arn:aws:s3:::sagebase-cloudtrail-231505186444
        - Sid: AWSCloudTrailWrite20150319
          Effect: Allow
          Principal:
            Service: cloudtrail.amazonaws.com
          Action: s3:PutObject
          Resource: arn:aws:s3:::sagebase-cloudtrail-231505186444/AWSLogs/*
          Condition:
            StringEquals:
              s3:x-amz-acl: bucket-owner-full-control
