Parameters:
  <<: !Include '../_parameters.yaml'

CloudwatchTrailLog: &cloudwatch-trail-log
  Type: update-stacks
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/master/templates/Cloudwatch/cloudwatch-log.yaml
  StackName: !Sub '${resourcePrefix}-cloudwatch-log'
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    Account: '*'
    IncludeMasterAccount: true
  TerminationProtection: true
  Parameters:
    RetentionInDays: 90

MasterCloudwatchTrailLog:
  <<: *cloudwatch-trail-log
  DefaultOrganizationBinding:
    Account: !Ref LogCentralAccount
  Parameters:
    RetentionInDays: 3653

MemberCloudwatchTrailLog:
  <<: *cloudwatch-trail-log
  DefaultOrganizationBinding:
    Account: '*'
    IncludeMasterAccount: true
    ExcludeAccount: !Ref LogCentralAccount

CloudTrail:
  Type: update-stacks
  DependsOn: [ "MasterCloudwatchTrailLog", "MemberCloudwatchTrailLog" ]
  Template: https://raw.githubusercontent.com/Sage-Bionetworks/aws-infra/master/templates/Cloudtrail/cloudtrail-trail.yaml
  StackName: !Sub '${resourcePrefix}-cloudtrail'
  StackDescription: CloudTrail
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    Account: '*'
    IncludeMasterAccount: true
  OrganizationBindings:
    LogArchiveBinding:
      Account: !Ref LogCentralAccount
  Parameters:
    bucketName: !Sub '${resourcePrefix}-cloudtrail-${CurrentAccount.AccountId}'
    CloudWatchLogsLogGroupArn: !CopyValue [ !Sub '${primaryRegion}-${resourcePrefix}-cloudwatch-log-LogGroupArn' ]
    CloudWatchLogsRoleArn: !CopyValue [ !Sub '${primaryRegion}-${resourcePrefix}-cloudwatch-log-LogRoleArn' ]
